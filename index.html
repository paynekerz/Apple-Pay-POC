<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQPro Apple Pay • PoC</title>

  <!-- Apple Pay JS (for feature checks) -->
  <script src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js" crossorigin></script>

  <!-- IQPro WalletJS (Apple Pay helper that returns temporary_token) -->
  <script src="https://sandbox.basysiqpro.com/walletjs/walletjs.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui; padding: 2rem; max-width: 760px; margin: 0 auto; }
    .row { margin: 1rem 0; }
    apple-pay-button { --apple-pay-button-width: 280px; --apple-pay-button-height: 44px; }
    .log { background: #0b1020; color:#e6edf3; padding:1rem; border-radius:8px; white-space:pre-wrap; }
    .ok { color: #0a8f3a; } .bad { color:#b3261e; }
    button { padding: .6rem 1rem; border-radius: 8px; border: 1px solid #ddd; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Apple Pay PoC (IQPro Sandbox)</h1>

  <!-- Simple Domain Registration: simulate verification UI -->
  <section class="row">
    <h2>Domain Registration</h2>
    <p>Place your <code>apple-developer-merchantid-domain-association.txt</code> file in
       <code>public/.well-known/</code>, then click the button below.</p>
    <button id="btn-check">Check Verification File</button>
    <span id="verify-status"></span>
  </section>

  <section class="row">
    <h2>Apple Pay Button & Flow</h2>
    <div id="button-wrap"></div>
    <div><small id="support-msg"></small></div>
  </section>

  <section class="row">
    <h2>Last Response</h2>
    <div id="out" class="log">—</div>
  </section>

<script>
// ---------- helpers ----------
const out = document.getElementById('out');
const log = (obj, label='') => {
  const text = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  out.textContent = label ? `${label}\n${text}` : text;
  console.log(label || 'LOG', obj);
};

// ---------- 1) Simple Domain Registration: simulate check ----------
document.getElementById('btn-check').addEventListener('click', async () => {
  const s = document.getElementById('verify-status');
  try {
    const res = await fetch('/.well-known/apple-developer-merchantid-domain-association.txt', { cache: 'no-store' });
    if (res.ok) {
      s.innerHTML = 'Status: <strong class="ok">Verification file accessible ✅</strong>';
    } else {
      s.innerHTML = 'Status: <strong class="bad">Not found / blocked ❌</strong>';
    }
  } catch (e) {
    s.innerHTML = 'Status: <strong class="bad">Request error ❌</strong>';
  }
});

// ---------- 2) Show Apple Pay button if available ----------
function applePaySupported() {
  try {
    return window.ApplePaySession &&
           ApplePaySession.supportsVersion(3) &&
           ApplePaySession.canMakePayments();
  } catch { return false; }
}
// (Apple docs: canMakePayments / supportsVersion) 
// This only checks availability, not that a card is provisioned. :contentReference[oaicite:7]{index=7}

const wrap = document.getElementById('button-wrap');
const supportMsg = document.getElementById('support-msg');

if (applePaySupported()) {
  const btn = document.createElement('apple-pay-button');
  btn.setAttribute('buttonstyle','black');
  btn.setAttribute('type','plain');
  btn.setAttribute('locale','en-US');
  btn.addEventListener('click', onApplePayClick);
  wrap.appendChild(btn);
  supportMsg.textContent = 'Apple Pay seems available on this device.';
} else {
  const fallback = document.createElement('button');
  fallback.textContent = 'Simulate Apple Pay (mock)';
  fallback.addEventListener('click', onApplePayClick);
  wrap.appendChild(fallback);
  supportMsg.textContent = 'Apple Pay not available here; using a mock sheet for demo.';
}

// ---------- 3) Use IQPro WalletJS to get a temporary_token, then run /api/transaction ----------
async function onApplePayClick() {
  try {
    // Initialize WalletJS Apple Pay instance with your key & domain (from env; injected by serverless echo)
    const cfg = await (await fetch('/api/echo-verify')).json(); // { keyId, domain }
    const ap = new walletjs.ApplePay({
      key: cfg.keyId,              // APPLEPAY_KEY_ID (IQPro Settings→Apple Pay)
      domain: cfg.domain,          // your deployment domain
      payment: {
        version: 3,
        merchantCapabilities: ["supports3DS", "supportsCredit", "supportsDebit"],
        supportedNetworks: ["visa", "masterCard", "discover"],
        countryCode: "US",
        merchantIdentifier: "merchant.example.sandbox" // placeholder; WalletJS handles simple-config path
      },
      details: {
        total: { label: "Demo Order", amount: { currency: "USD", value: "1.23" } }
      },
      options: { requestShipping: false }
    });

    // This triggers the WalletJS Apple Pay flow or a mock where not supported and returns a token.
    const tokenResp = await ap.submit(); // yields { temporary_token: "..." } in the simple flow
    log(tokenResp, 'Tokenizer (WalletJS) response:');
    if (!tokenResp || !tokenResp.temporary_token) {
      throw new Error('No temporary_token returned from WalletJS.');
    }

    // Send to our serverless function to call IQPro /api/transaction securely with the secret key
    const txn = await fetch('/api/transaction', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        type: 'authorize',        // or 'sale' for a one-step flow
        amount: 123,              // cents
        apple_pay_temporary_token: tokenResp.temporary_token
      })
    }).then(r => r.json());

    log(txn, 'Transaction response:');
  } catch (err) {
    log({ error: String(err) }, 'Error:');
  }
}
</script>
</body>
</html>
